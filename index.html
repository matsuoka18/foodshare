<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>フードロスなくそう</title>
  <link rel="stylesheet" href="home1.css">
  </head>
  <body onload="start()">
    <div class="alll2" id="alll2">
      <input type="text" id="logp" value="" placeholder="パスワードを入力してください">
      <div id="a"></div>
    </div>
    <div class="alll" id="alll">
      <div id="a"></div>
    <div class="section1">
      <div class="head">
        <div class="p">
          <p onclick="カート()">カート</p>
       <ul class="l4">
            <li class="l1"><a class="a1"href="店舗側.html">店舗側ページ</a></li>
            <li class="l2"><a class="a2"href="店舗登録.html">店舗登録</a></li>
            <li class="l3"><a class="a3"href="login.html">ログイン</a></li>
            <li class="l5">店舗情報</li>
        </ul>
            
        </div>
        <div class="searchform">
      <input type="text"class="search"id="search"placeholder="shopname or menu"value="">
      <button id="s"onclick="searching()"><span id="ss">search</span></button>
      <p class="genre">ジャンルを一覧</p>
    </div>

  </div>
    <h1 class="h1">foodshare</h1>

  </div>
  <div class="img4">
  <div class="img2">
    <img id="img"class="img1">
      <!--div class="img3"></div-->
</div>
</div>
<div class="no2">
<div class="pop">
  <p class="popp">人気のある商品</p>
  <div class="no1">
    <p class="shopname">ローソン</p>
    <div class="menufee">
    <p class="menu">Lチキ旨辛</p>
    <p class="fee">200円</p>
    </div>
    <p class="express">ローソン自慢の定番商品、創業当時から変わらない味付けでお客様よりしたしまれてきました。今、期間限定で旨辛味が販売されているのでぜひご購入ください</p>
    <div class="pic"></div>
    </div>
    <div class="no1">
      <p class="shopname">ローソン</p>
      <div class="menufee">
      <p class="menu">Lチキ旨辛</p>
      <p class="fee">200円</p>
      </div>
      <p class="express">ローソン自慢の定番商品、創業当時から変わらない味付けでお客様よりしたしまれてきました。今、期間限定で旨辛味が販売されているのでぜひご購入ください</p>
      <div class="pic"></div>
      </div>
      <div class="no1">
        <p class="shopname">ローソン</p>
        <div class="menufee">
        <p class="menu">Lチキ旨辛</p>
        <p class="fee">200円</p>
        </div>
        <p class="express">ローソン自慢の定番商品、創業当時から変わらない味付けでお客様よりしたしまれてきました。今、期間限定で旨辛味が販売されているのでぜひご購入ください</p>
        <div class="pic"></div>
        </div>
        <div class="no1">
          <p class="shopname">ローソン</p>
          <div class="menufee">
          <p class="menu">Lチキ旨辛</p>
          <p class="fee">200円</p>
          </div>
          <p class="express">ローソン自慢の定番商品、創業当時から変わらない味付けでお客様よりしたしまれてきました。今、期間限定で旨辛味が販売されているのでぜひご購入ください</p>
          <div class="pic"></div>
          </div>
          <div class="no1">
            <p class="shopname">ローソン</p>
            <div class="menufee">
            <p class="menu">Lチキ旨辛</p>
            <p class="fee">200円</p>
            </div>
            <p class="express">ローソン自慢の定番商品、創業当時から変わらない味付けでお客様よりしたしまれてきました。今、期間限定で旨辛味が販売されているのでぜひご購入ください</p>
            <div class="pic"></div>
            </div>         
</div>
</div>
<div class="foot">
  <p class="news2">お知らせ</p>
  <div class="news">
    <p>サイト解説のお知らせ</p>
    <p>684213523</p>
    <p>654674</p>
    <p>677604</p>
    <p>7654745</p>
    <p>683214</p>
    <p>677604</p>
    <p>7654745</p>
</div>
</div>
<div class="place">
  <div class="place2">エリア検索</div>
  <div class="p2">
  <p class="p1">北海道地方</p>
  <p>北海道</p>
  </div>
  <div class="p2">
  <p class="p1">東北地方</p>
  <p>青森県</p>
  <p>岩手県</p>
  <p>宮城県</p>
  <p>秋田県</p>
  <p>山形県</p>
  <p>福島県</p>
</div>
  <div class="p2">
  <p class="p1">関東地方</p>
  <p>茨城県</p>
  <p>栃木県</p>
  <p>群馬県</p>
  <p>埼玉県</p>
  <p>千葉県</p>
  <p>東京都</p>
  <p>神奈川県</p>
</div>
  <div class="p2">
  <p class="p1">中部地方</p>
  <p>新潟県</p>
  <p>富山県</p>
  <p>石川県</p>
  <p>福井県</p>
  <p>山梨県</p>
  <p>長野県</p>
  <p>岐阜県</p>
  <p>静岡県</p>
  <p>愛知県</p>
</div>
  <div class="p2">
  <p class="p1">近畿地方</p>
<p>三重県</p>
<p>滋賀県</p>
<p>京都府</p>
<p>大阪府</p>
<p>兵庫県</p>
<p>奈良県 </p> 
<p>和歌山県</p>
</div>
<div class="p2">
<p class="p1">中国・四国地方</p>
<p>鳥取県</p>
<p>島根県</p>
<p>岡山県</p>
<p>広島県</p>
<p>山口県</p>
<p>徳島県</p>
<p>香川県</p>
<p>愛媛県</p>
<p>高知県 </p>
</div>
<div class="p2">
<p class="p1">九州地方</p>
<p>福岡県</p>
<p>佐賀県</p>
<p>長崎県</p>
<p>熊本県</p>
<p>大分県</p>
<p>宮崎県</p>
<p>鹿児島</p>
<p>沖縄県</p>                                              
</div>
</div>
</div>
<div class="bottom" >
  <div class="botton1"><img src="foodshare2.PNG">FoodShare</div>
  <div class="bottom2">
  <li>トップページ</li>
  <li>店舗登録</li>
  <li>ログイン</li>
  </div>
  <p>copy right FoodShare</p>

</div>
<style>
  .bottom{
            width:100vw;
            height:10vw;
            background-color:#3A1F00;
            text-align:center;
            color:white;
            
        }
.bottom p{
    padding-top:2vw;
}
.bottom li{
    display:block;
    list-style: none;
    padding:5px;
}
.bottom a{
    color:white;

}
.botton1{
    position:relative;top:1vw;left:1vw;
    width:25vw;
    height:8vw;
    background-color:#C6AC8F;
    border-radius:10px;
    z-index:100;
    font-size:2vw;
    font-weight:600;
    color:#3A1F00;
    display: flex;
  justify-content: center;
  align-items: center;
}
.botton1 img{
    padding:0;
    margin-right:3vw;
    margin-left:-2vw;
    width:7vw;
    height:auto;
}
.bottom2{
    position:relative;
    margin-top:-8vw;
padding-top:1vw;
}
  .alll{
    opacity:0;
  }
  .alll2{
    opacity:0;
    padding: 0;
    margin:0;
  }

  .head li{
                 position:absolute;top:6vw;left:85vw;
                  text-decoration:none;
                   list-style-type:none;
                   width:100px;
                   color:white;
                   font-weight:600;
            height:30px;
              border-radius:10px;
              background-color:#5A3A1A;
              text-align:center;
            }
            a{
               text-decoration:none;
                 color:white;
                   font-weight:600;
               
            }
            .l1{
               text-decoration:none;
              
                transition:1.0s;
            }
            .l2{
               
                transition:1.0s;
            }
            .l3{
              
           
                transition:1.0s;
            }
            .l4{
                width:100px;
                height:30px;
                padding:0;
                margin:0;
            }
            .l5{
              transition:1s;
            }
            .l5:hover {
                  background-color:#BC9A78;
                  color:#5A3A1A;
            }
            
            .l4:hover .l1{
                transform:translate(0px,30px);
            }
              .l4:hover .l2{
                transform:translate(0px,60px);
               
            }
              .l4:hover .l3{
                transform:translate(0px,90px);
               
            }
            .l1:hover{
               transition:0.2s;
                   background-color:#BC9A78;
                   color:#5A3A1A;
            }
               .l2:hover{
               transition:0.2s;
                   background-color:#BC9A78;
                   color:#5A3A1A;
            }
               .l3:hover{
               transition:0.2s;
                   background-color:#BC9A78;
                   color:#5A3A1A;
            }
                  .a1:hover{
               transition:0.2s;
                   background-color:#BC9A78;
                   color:#5A3A1A;
            }
               .a2:hover{
               transition:0.2s;
                   background-color:#BC9A78;
                   color:#5A3A1A;
            }
               .a3:hover{
               transition:0.2s;
                   background-color:#BC9A78;
                   color:#5A3A1A;
            }
            .l1 a:active{
             
              color:white;
            }
              .l2 a:active{
          
              color:white;
            }
              .l3 a:active{
          
              color:white;
            }
</style>
<script src="a.js"></script>
        <script>
          a = 0;
          ipadress='';
          function start(){
            fetch('https://ipinfo.io?callback')
  .then(res => res.json())
  .then(json => {
    ip = json.ip;
  if(ip == '60.134.235.1'){
    document.getElementById("alll").style.opacity = "1";
    document.getElementById("alll2").style.display = "none";
    pic();
    console.log("firstdata start>>");
    firstsearch();//ページ読み込みの際に全データを取得
  }else{
    document.getElementById("alll2").style.opacity = "1";
    data = "<h1>ログインせい</h1><h2>パスワード</h2>";
    alll2.insertAdjacentHTML('afterbegin',data);
  }
});
          }
          logp = document.getElementById("logp");
          document.getElementById("logp").addEventListener('keyup',keycheck);
          function keycheck(){
            if(logp.value == "papa"){
              document.getElementById("alll2").style.display = "none";
              document.getElementById("alll").style.opacity = "1";
              pic();
            }
          }
          function pic(){
            if(a == 0){
              a = 1;
            document.getElementById("img").src="food.jpeg";
            setTimeout(pic,5000);
            }else{
              a = 0;
              document.getElementById("img").src="IMG_0064.JPG";
              setTimeout(pic,5000);
          }
        }
        function shop(){
          location.href="登録ページ.html";
        }
        document.getElementById("search").addEventListener('keyup',event =>{
 if(event.keyCode == 13){
  searching();
 }
        });

//取得時に全データ取得　始
firstdata1 = '';
        firstdata2 = '';
        success1 =  '';
        success2 =  '';
        request1 = '';
        request2 = '';
        request3 = '';
        function firstsearch(){
          url = "https://script.google.com/macros/s/AKfycbwBH_VrPaXcJg8HOXfoWHJY8f0Ir3935fqlJlURpyAkd8IdEQ/exec";
var data = [{
"branch":"shopdata"
}]
var params={
"method":"post",
"mode":"no-cors",
"Content-Type":"application/json",
"body":JSON.stringify(data)
}
fetch(url,params);
console.log("firstsearch1 ok")
success1 = "o";
setTimeout(firstsearch2,2000);
        }

        function firstsearch2(){
          fetch('https://script.google.com/macros/s/AKfycbwBH_VrPaXcJg8HOXfoWHJY8f0Ir3935fqlJlURpyAkd8IdEQ/exec',{
            method:"GET",
            moe:"cors"
          })
          .then(response =>{
            if(response.ok){
              return response.json()
            }
          })
          .then(resJson =>{
firstdata1 = resJson;
success1 = "ok";
console.log("firstsearch2 ok");
console.log("firstsearch finish");
console.log("firstmenusearch start>>");
if(request1 == "next"){
  console.log("shopsearchへ優先処理")
  shopsearch(resJson);
}else{
firstmenu();
}
          })
        .catch(error =>{
          num = 1;
ani();
$('#ss').clearQueue();
   $('#ss').stop();
   document.getElementById("ss").innerHTML = "search";
   document.getElementById("s").style.backgroundColor ="#5A3A1A";

   alert("通信失敗1")
        })
        }
function firstmenu(){
    if(request2 == "nomal"){
      console.log("menusearch 通常処理　受付");
    return;
  }
  console.log("firstmenusearch ok");
  url = "https://script.google.com/macros/s/AKfycbwBH_VrPaXcJg8HOXfoWHJY8f0Ir3935fqlJlURpyAkd8IdEQ/exec";
var data = [{
"branch":"menu"
}]
var params={
"method":"post",
"mode":"no-cors",
"Content-Type":"application/json",
"body":JSON.stringify(data)
}
fetch(url,params);
console.log("firstmenusearch1 ok");
success2 = "o";
setTimeout(firstmenu2,2000);
}
function firstmenu2(){
  if(request2 == "nomal"){
    console.log("menusearch 通常処理　受付");
    return;
  }
  console.log("firstmenu2 ok");
  fetch('https://script.google.com/macros/s/AKfycbwBH_VrPaXcJg8HOXfoWHJY8f0Ir3935fqlJlURpyAkd8IdEQ/exec',{
            method:"GET",
            moe:"cors"
          })
          .then(response =>{
            if(response.ok){
              return response.json()
            }
          })
          .then(resJson =>{
            console.log("firstmenusearch2 ok");
firstdata2 = resJson;
console.log("firstdata 1/2 finish");
console.log("wait for instructions");
success2 = "ok";
if(request2 == "next"){
  console.log("menusearch2へ優先処理  in menu2")
  menusearch2(resJson);
}
          })
        .catch(error =>{
          num = 1;  
ani();
$('#ss').clearQueue();
   $('#ss').stop();
   document.getElementById("ss").innerHTML = "search";
   document.getElementById("s").style.backgroundColor ="#5A3A1A";

   alert("通信失敗2")
        })
}
//ロード時に全データ取得のコード　終
shopname = '';
        function searching(){
          num = 100;
          request3 = '';
          ani();
document.getElementById("ss").innerHTML = "loading";
document.getElementById("s").style.backgroundColor ="#C6AC8F"
          shopname = document.getElementById("search").value;
            if(success1 == "ok"){
            console.log("data:"+firstdata1)
shopsearch(firstdata1);
return;
          }
          if(success1 == "o"){
          console.log("途中からのリクエスト1");
          request1 = "next";
          return; //違う可能性大
      }else{
          url = "https://script.google.com/macros/s/AKfycbwBH_VrPaXcJg8HOXfoWHJY8f0Ir3935fqlJlURpyAkd8IdEQ/exec";
var data = [{
"branch":"shopdata"
}]
var params={
"method":"post",
"mode":"no-cors",
"Content-Type":"application/json",
"body":JSON.stringify(data)
}
fetch(url,params);
setTimeout(searching2,3000);
        }
      }
function searching2(){
          fetch('https://script.google.com/macros/s/AKfycbwBH_VrPaXcJg8HOXfoWHJY8f0Ir3935fqlJlURpyAkd8IdEQ/exec',{
            method:"GET",
            moe:"cors"
          })
          .then(response =>{
            if(response.ok){
              return response.json()
            }
          })
          .then(resJson =>{
            if(request2 == "next"){
              console.log("menusearch2への優先処理");
              menusearch2(resJson);
              
            }
shopsearch(resJson);
          })
        .catch(error =>{
          num = 1;
ani();
$('#ss').clearQueue();
   $('#ss').stop();
   document.getElementById("ss").innerHTML = "search";
   document.getElementById("s").style.backgroundColor ="#5A3A1A";

   alert("通信失敗1")
        })
        }
        
        function shopsearch(resJson){
          json = JSON.stringify(resJson);
json = JSON.parse(json);
a = "n1";
json = json.shopdata[0];
num = json.num+6;
for(a = -5; a<num; a+=6){
  text = "n"+a;
  shopname2 = json[text];
  if(shopname == shopname2){
    text2 = "searchnum="+a+"$";
        shopname2 = encodeURI(shopname2);
    text3 = "searchname="+shopname2+"^";
    document.cookie = text2;
    document.cookie = text3;
document.getElementById("ss").innerHTML = "jumping";
ttt = '';
document.cookie = "branch=shop|";
    setTimeout(jump,1000);
    return;
  }
}
if(typeof ttt == 'undefined'){
/*alert("店舗を発見できません");
document.getElementById("ss").innerHTML = "search";
num = 1;
ani();
$('#ss').clearQueue();
   $('#ss').stop();
   document.getElementById("s").style.backgroundColor ="#5A3A1A";*/

  if(success2 == "ok"){
console.log("data2:"+firstdata2);
menusearch2(firstdata2);
return;
}
if(success2 == "o"){
console.log("途中からのリクエスト2");
request2 = "next";
return;//間違えて可能性大
}else{
  console.log("menusearch  通常処理")
  request2 = "nomal";
   menusearch();
}
}
        }
function jump(){
  num = 1;
          ani();
          document.getElementById("s").style.backgroundColor ="#5A3A1A";

location.href="商品表示.html";
}
function ani(){
  //alert(num);
  for(var a = 0; a<num; a++){
    $("#ss").animate({
    opacity:1
  },{
    'duration':0
    })
  $("#ss").animate({
    opacity:0
  },{
    'duration':1000
  })
  $("#ss").animate({
    opacity:1
  },{
    'duration':0
    })
}
if(num == 1){
  document.getElementById("ss").style.opacity = "1";
  document.getElementById("s").style.backgroundColor ="#5A3A1A";
}
}
function menusearch(){
  console.log("menusearch ok");
  url = "https://script.google.com/macros/s/AKfycbwBH_VrPaXcJg8HOXfoWHJY8f0Ir3935fqlJlURpyAkd8IdEQ/exec";
var data = [{
"branch":"menu"
}]
var params={
"method":"post",
"mode":"no-cors",
"Content-Type":"application/json",
"body":JSON.stringify(data)
}
fetch(url,params);
setTimeout(menu2,3000);
}
function menu2(){
  console.log("menu2 ok");
  fetch('https://script.google.com/macros/s/AKfycbwBH_VrPaXcJg8HOXfoWHJY8f0Ir3935fqlJlURpyAkd8IdEQ/exec',{
            method:"GET",
            moe:"cors"
          })
          .then(response =>{
            if(response.ok){
              return response.json()
            }
          })
          .then(resJson =>{
            console.log("menusearch2 ok");
menusearch2(resJson);
          })
        .catch(error =>{
          num = 1;  
ani();
$('#ss').clearQueue();
   $('#ss').stop();
   document.getElementById("ss").innerHTML = "search";
   document.getElementById("s").style.backgroundColor ="#5A3A1A";

   alert("通信失敗2")
        })
}


function menusearch2(resJson2){
  if(request3 == "end"){
    console.log("end")
    
  }else{
jsonnn = JSON.stringify(resJson2);
console.log("JSON文字列↓");
console.log(jsonnn);
jsonn = JSON.parse(jsonnn);
console.log("JS文字列↓");
console.log(jsonn)
last = jsonn["last"];
console.log("last:"+last);
nummemo = [];
nummemo = [];
nummemo2 = [];
nummemo3 = 0;
for(var a = 1; a<=last; a+=6){
  shopp  = String("shop"+a);
  shoppi = "\""+shopp+"\""+":";
  if(jsonnn.includes(shopp) === true){
    menu = jsonn[shopp];
  console.log(menu);
   menulast = menu.length;
   console.log(menulast);
  }else{
    console.log(shopp+":undefined");
  }
  for(var i = 0; i<menulast; i++){
     menuname = menu[i];
  if(menuname == shopname){
    nummemo3++;
    console.log(menuname+"発見");
    i = String(i);
    nummemo2.push(i);
    console.log(nummemo2);
    aa = 'ok';
  }
}
if(typeof aa == 'string'){
nummemo2 = JSON.stringify(nummemo2);
console.log(nummemo2);
info = shoppi+nummemo2;
console.log(info);
nummemo.push(info);
nummemo2 = [];
aa = 0;
ss = String(a);
}
}
console.log(a)
if(a >= last && nummemo3 > 0){
  console.log(nummemo);
  nummemo = nummemo.toString().replace("\'","");
  nummemo = "{"+nummemo+","+"\""+"last"+"\""+":"+"["+"\""+ss+"\""+"]"+"}";
  console.log(nummemo);
  console.log(nummemo3+":店舗発見")
  num = 1;  
ani();
$('#ss').clearQueue();
   $('#ss').stop();
   document.getElementById("ss").innerHTML = "search";
   document.getElementById("s").style.backgroundColor ="#5A3A1A";
   cc = "menumemo="+nummemo+"-";
   document.cookie = "branch=menu|";
   document.cookie = cc;
   document.getElementById("ss").innerHTML = "jumping";
jump();
  }else{
  ani();
$('#ss').clearQueue();
   $('#ss').stop();
   document.getElementById("ss").innerHTML = "search";
   document.getElementById("s").style.backgroundColor ="#5A3A1A";
console.log("店舗・商品がありません");
alert("店舗・商品がありません");
/*if(request2 == "next"){
  request3 = "end";
  console.log("検索終了");
  end();
}*/
if(success2 != "ok"){
    request2 = '';
    console.log("firstmenu  再トライ")
    firstmenu();
  }
request3 = "end";
  console.log("検索終了");
  end();
}
  }
}
function end(){
  console.log("検索 終了");
const flag = true;
 
 try {
  
     if (flag) {
         throw new Error('終了します');
     }
     console.log('実行されないコード');
  
 } catch (e) {
  
     console.log(e.message);
  
 }
}
        </script>
    </body>
</html>
